---
title: 这样讲闭包，你终生难忘
date: 2016-12-08 15:06:37
tags: [javascript]
categories: javascript核心
comments: true
---
### JavaScript核心-闭包

#### 闭包（Closure）

关于闭包，真的是看了忘忘了看，相信这次应该理解了~

##### 变量的作用域

ES5中规定的JavaScript的变量作用域有两种：全部变量和局部变量（ES6中引入块级作用域）

javascript有两种特殊的属性

* 函数内部可以直接读取全局变量

```javascript
var n=999;
function f1(){
　　alert(n);
}
f1(); // 999
```
* 函数外部不能够读取局部变量

```javascript
function f1(){
　　var n=999;
}
alert(n); // error
```
**注意** 函数内部定义变量使用var，否则你定义的就是一个全局变量

```javascript
function f1(){
　　n=999;
}
f1();
alert(n); // 999
```

<!-- more -->


##### 如何从外部读取局部变量

上边讲到，正常情况下，外部无法读取局部变量，想要读取局部变量怎么办？
***就是在函数内部在定义一个函数***

```javascript
function f1(){
　　var n=999;
　　function f2(){
　　　　alert(n); // 999
　　}
}
```
在上面的代码中，函数f2就被包括在函数f1内部，这时f1内部的所有局部变量，对f2都是可见的。但是反过来就不行，f2内部的局部变量，对f1就是不可见的。这就是Javascript语言特有的"链式作用域"结构（chain scope），子对象会一级一级地向上寻找所有父对象的变量。所以，父对象的所有变量，对子对象都是可见的，反之则不成立.

***f2可以读取f1中的变量，将f2作为返回值，那么f1的外部我们就可以读取内部变量了***

```javascript
function f1(){
　　var n=999;
　　function f2(){
　　　　alert(n);
　　}
　　return f2;
}
var result=f1();
result(); // 999
```
##### 闭包的概念

上述代码中f2就是闭包，下面看看抽象的闭包~

> 闭包：闭包是一个代码块（在ECMAScript是一个函数）和以静态方式/词法方式进行存储的所有父作用域的一个集合体。所以，通过这些存储的作用域，函数可以很容易的找到自由变量。

看看容易理解的闭包概念

> 由于在Javascript语言中，只有函数内部的子函数才能读取局部变量，因此可以把闭包简单理解成"定义在一个函数内部的函数"。
  所以，在本质上，闭包就是将函数内部和函数外部连接起来的一座桥梁。

##### 闭包的用途

* 可以读取函数内部的变量
* 就是让这些变量的值始终保持在内存中

```javascript
function f1(){
　　var n=999;
　　nAdd=function(){n+=1}
　　function f2(){
　　　　alert(n);
　　}
　　return f2;
}
var result=f1();
result(); // 999
nAdd();#不要怀疑在外部为什么还可以调用，nAdd()是挂载在window下的
result(); // 1000
```

result其实就是闭包f2函数，一共运行两次，一次999二次1000。这就说明f1局部变量一直在内存当中，
并没有在被调用之后被自动的清楚。

为什么会这样呢？原因就在于f1是f2的父函数，而f2被赋给了一个全局变量，这导致f2始终在内存中，而f2的存在依赖于f1，因此f1也始终在内存中，不会在调用结束后，被垃圾回收机制（garbage collection）回收。

**注意**nAdd的值是一个匿名函数（anonymous function），而这个匿名函数本身也是一个闭包，所以nAdd相当于是一个setter，可以在函数外部对函数内部的局部变量进行操作。

##### 使用闭包的注意点

* 由于闭包会使得函数中的变量都被保存在内存中，内存消耗很大，所以不能滥用闭包，否则会造成网页的性能问题，在IE中可能导致内存泄露。解决方法是，在退出函数之前，将不使用的局部变量全部删除。
* 闭包会在父函数外部，改变父函数内部变量的值。所以，如果你把父函数当作对象（object）使用，把闭包当作它的公用方法（Public Method），把内部变量当作它的私有属性（private value），这时一定要小心，不要随便改变父函数内部变量的值。

##### 思考题

1. 题1

```javascript
var name = "The Window";
var object = {
　　name : "My Object",
　　getNameFunc : function(){
　　　　return function(){
　　　　　　return this.name;
　　　　};
　　}
};
alert(object.getNameFunc()());
```
2. 题2

```javascript
var name = "The Window";
var object = {
　　name : "My Object",
　　getNameFunc : function(){
　　　　var that = this;
　　　　return function(){
　　　　　　return that.name;
　　　　};
　　}
};
alert(object.getNameFunc()());
```

### 参考资料
* [闭包](http://www.ruanyifeng.com/blog/2009/08/learning_javascript_closures.html)
* [JavaScript核心](http://weizhifeng.net/javascript-the-core.html#closures)